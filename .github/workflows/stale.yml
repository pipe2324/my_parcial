name: Verificar mensaje enviado en la app de Android

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  verificar-mensaje:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v2

      - name: Configurar JDK 1.8
        uses: actions/setup-java@v1
        with:
          java-version: 1.8

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Conectar dispositivo/emulador Android
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          script: adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done; input keyevent 82'
          
      - name: Extraer el mensaje enviado en la app
        run: |
          mensaje=$(adb logcat -d | grep "Mensaje enviado:" | cut -d ":" -f 2 | xargs)
          echo "Mensaje enviado desde la app de Android: $mensaje"

      - name: Verificar si el mensaje es correcto
        run: |
          mensaje_esperado="Mensaje de prueba"
          if [ "$mensaje" == "$mensaje_esperado" ]; then
            echo "El mensaje enviado desde la app de Android es correcto: $mensaje"
          else
            echo "ERROR: El mensaje enviado desde la app de Android no es correcto. Se esperaba '$mensaje_esperado' pero se recibi√≥ '$mensaje'."
            exit 1
          fi
